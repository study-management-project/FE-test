<!DOCTYPE html>
<html>

<head>
    <title>Chat Rooms</title>
    <style>
        #roomList,
        #chatRoom {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }

        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="roomList">
        <h2>Room List</h2>
        <ul id="rooms"></ul>
        <input type="text" id="newRoomName" placeholder="New room name" />
        <input type="text" id="newRoomDescription" placeholder="New room description" />
        <button onclick="createRoom()">Create Room</button>
    </div>

    <div id="chatRoom" style="display: none;">
        <h2>Chat Room: <span id="roomName"></span></h2>
        <p id="roomDescription"></p>
        <textarea id="message" rows="4" cols="50"></textarea>
    </div>

    <div>
        <h2>Login</h2>
        <input type="email" id="email" placeholder="email">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <div>
        <h2>Logout</h2>
        <button onclick="logout()">Logout</button>
    </div>

    <div>
        <h2>Check Login Status</h2>
        <button onclick="checkLogin()">Check</button>
    </div>

    <div id="result">
        <!-- Result of login, logout, and check will be displayed here -->
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentRoomId = null;
        let currentSubscription = null;
        let subscriberSubscription = null;
        let serverURL = 'http://localhost:8080'
        // let serverURL = 'http://175.192.72.85:8080'

        function connect() {
            var socket = new SockJS(`${serverURL}/ws`);
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                loadRooms();
            });
        }

        function loadRooms() {
            fetch(`${serverURL}/rooms`)
                .then(response => response.json())
                .then(rooms => {
                    var roomList = document.getElementById('rooms');
                    roomList.innerHTML = '';
                    rooms.forEach(room => {
                        var li = document.createElement('li');
                        li.appendChild(document.createTextNode(room.name));
                        li.onclick = function () { joinRoom(room.id, room.name, room.description); };
                        roomList.appendChild(li);
                    });
                });
        }

        function createRoom() {
            var roomName = document.getElementById('newRoomName').value;
            var roomDescription = document.getElementById('newRoomDescription').value;
            fetch(`${serverURL}/room`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: roomName,
                    description: roomDescription
                })
            })
                .then(response => response.json())
                .then(room => {
                    document.getElementById('newRoomName').value = '';
                    document.getElementById('newRoomDescription').value = '';
                    loadRooms();
                });
        }

        function joinRoom(id, roomName, roomDescription) {
            // 이전 구독 해제
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }

            currentRoomId = id;
            document.getElementById('roomName').textContent = roomName;
            document.getElementById('roomDescription').textContent = roomDescription;
            document.getElementById('roomList').style.display = 'none';
            document.getElementById('chatRoom').style.display = 'block';

            if (stompClient.connected) {
                // 데이터 공유를 위한 구독
                currentSubscription = stompClient.subscribe('/topic/' + id, function (messageOutput) {
                    setMessage(messageOutput.body);
                });
            }

            fetch(`${serverURL}/room/${id}`)
                .then(response => response.json())
                .then(data => {
                    setMessage(data.content);
                })
                .catch(error => console.error('Error fetching room content:', error));
        }


        function setMessage(message) {
            document.getElementById('message').value = message;
        }

        // 입력이 멈추고 0.5초 후에 메시지 전송
        let typingTimer;
        document.getElementById('message').addEventListener('input', function () {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                var content = document.getElementById('message').value;
                stompClient.send("/send-text", {}, JSON.stringify({ 'id': currentRoomId, 'content': content }));
            }, 500);
        });

        // 페이지를 나갈 때 구독 해제
        window.addEventListener('beforeunload', function () {
            if (currentSubscription) {
                currentSubscription.unsubscribe();
            }
        });

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            const response = await fetch(`${serverURL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });

            const result = await response.text();
            document.getElementById('result').textContent = result;
        }

        async function logout() {
            const response = await fetch(`${serverURL}/logout`, {
                method: 'POST'
            });

            const result = await response.text();
            document.getElementById('result').textContent = result;
        }

        async function checkLogin() {
            const response = await fetch(`${serverURL}/check`);
            const result = await response.text();
            document.getElementById('result').textContent = result;
        }

        connect();
    </script>
</body>

</html>