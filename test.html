<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Room Text Sharing</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>

<body>
    <h1>Room: <span id="roomName"></span></h1>
    <textarea style="width: 300px; height: 300px;" id="messageInput" placeholder="Type a message..."></textarea>

    <script>
        let stompClient = null;
        const roomId = "1";  // 방번호 1로 설정
        const serverURL = 'http://localhost:8080';

        // 초기 로딩 시 db에서 content 받아오기
        function fetchRoomContent() {
            fetch(`${serverURL}/api/room/${roomId}`)
                .then(response => {
                    if (!response.ok) { // 응답 상태 코드가 200~299 범위가 아닌 경우
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.text(); // 응답 본문을 문자열로 변환
                })
                .then(data => {
                    document.getElementById('messageInput').value = data; // textarea에 값 설정
                })
                .catch(error => console.error('Error fetching room content:', error));
        }

        function connect() {
            var socket = new SockJS(`${serverURL}/ws`); // 서버 엔드포인트와 일치해야 함
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                // topic 수신 시 input box에 세팅
                stompClient.subscribe("/topic/" + roomId, function (messageOutput) {
                    setMessage(messageOutput.body);
                });
            }, function (error) {
                console.error('STOMP error:', error);
            });
        }

        function setMessage(message) {
            document.getElementById('messageInput').value = message;
        }

        // 입력이 멈추고 0.1초 후에 메시지 전송
        let typingTimer;
        document.getElementById('messageInput').addEventListener('input', function () {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(function () {
                var content = document.getElementById('messageInput').value;
                stompClient.send("/send-text", {}, JSON.stringify({ 'roomId': roomId, 'content': content }));
            }, 500);
        });

        window.onload = function () {
            fetchRoomContent();
            connect();
        };
    </script>
</body>

</html>