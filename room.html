<!DOCTYPE html>
<html>
<head>
    <title>Chat Rooms</title>
    <style>
        #roomList, #chatRoom {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #codes {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
        }
        #snapshotList, #commentList {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="chatRoom">
        <h2>Chat Room: <span id="roomName"></span></h2>
        <p id="roomDescription"></p>
        <div id="snapshotList">
            <h3>Snapshots:</h3>
            <ul id="snapshots"></ul>
        </div>

        <div id="commentList">
            <h3>Comments:</h3>
            <ul id="comments"></ul>
        </div>

        <textarea id="comment" rows="4" cols="50"></textarea>
        <button id="comment-submit">채팅전송</button>

        <div id="checkUp">
            <h3>Check Up:</h3>
            <p id="checkUpTitle"></p>
        </div>

        <input id="snapshot-title" placeholder="snapshot-title"> <br>
        <textarea id="code" rows="4" cols="50" placeholder="code"></textarea>
        <button id="snapshot-submit">스냅샷 생성</button>
    </div>

    <div id="auth">
        <form id="loginForm">
            <input id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">로그인</button>
        </form>
        <button id="logoutButton">로그아웃</button>
        <button id="check">인증체크</button>
    </div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script>
        let stompClient = null;
        let currentRoomId = 'bc31c700-8318-46a9-b6aa-bed717ba1663';

        let codeSubscription = null;
        let commentSubscription = null;
        let snapshotSubscription = null;

        let serverURL = 'http://localhost:8080'

        // 소켓 연결 (SockJS 기반으로 Stomp 생성)
        function connect() {
            var socket = new SockJS(`${serverURL}/ws`);
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);
                joinRoom(currentRoomId);
            });
        }

        // 기존 구독 초기화
        function clearSubscription() {
            if (codeSubscription) codeSubscription.unsubscribe();
            if (commentSubscription) commentSubscription.unsubscribe();
            if (snapshotSubscription) snapshotSubscription.unsubscribe();
        }

        // 예기치 않은 종료 시에도 구독 초기화
        window.addEventListener('beforeunload', function () {
            clearSubscription();
        });

        function joinRoom(roomId) {
            clearSubscription();
            
            fetch(`${serverURL}/room/${roomId}`)
                .then(response => response.json())
                .then(data => {
                    displayRoomInfo(data);
                })
                .catch(error => console.error('Error fetching room content:', error));

            if (stompClient.connected) {
                codeSubscription = stompClient.subscribe('/topic/' + roomId + '/code', function (codeOutput) {
                    setCode(codeOutput.body);
                });

                commentSubscription = stompClient.subscribe('/topic/' + roomId + '/comment', function (commentOutput) {
                    addComment(commentOutput.body);
                });

                snapshotSubscription = stompClient.subscribe('/topic/' + roomId + '/snapshot', function (latestSnapshot) {
                    addSnapshot(latestSnapshot.body);
                });
            }
        }

        // room 상세정보 출력
        function displayRoomInfo(data) {
            document.getElementById('roomName').textContent = data.name;
            document.getElementById('roomDescription').textContent = data.description;
            document.getElementById('code').value = data.content;

            const snapshotsList = document.getElementById('snapshots');
            snapshotsList.innerHTML = '';
            data.snapshotList.forEach(snapshot => {
                const li = document.createElement('li');
                li.textContent = `${snapshot.title} ${snapshot.content} (${snapshot.createdDate})`;
                snapshotsList.appendChild(li);
            });

            const commentsList = document.getElementById('comments');
            commentsList.innerHTML = '';
            data.commentList.forEach(comment => {
                const li = document.createElement('li');
                li.textContent = comment;
                commentsList.appendChild(li);
            });

            document.getElementById('checkUpTitle').textContent = data.checkUp.title;
        }

        // 코드쉐어 부분
        let timer;
        document.getElementById('code').addEventListener('input', function () {
            clearTimeout(timer);
            timer = setTimeout(function () {
                var content = document.getElementById('code').value;
                stompClient.send("/share-code", {}, JSON.stringify({ 'uuid': currentRoomId, 'content': content }));
            }, 500);
        });

        function setCode(code) {
            document.getElementById('code').value = code;
        }


        // 댓글 부분
        document.getElementById('comment-submit').addEventListener('click', function () {
            var content = document.getElementById('comment').value;
            stompClient.send("/share-comment", {}, JSON.stringify({ 'uuid': currentRoomId, 'content': content }));
        });

        function addComment(comment) {
            const commentsList = document.getElementById('comments');
            const li = document.createElement('li');
            li.textContent = comment;
            commentsList.appendChild(li);
        }

        // 스냅샷 부분
        document.getElementById('snapshot-submit').addEventListener('click', function () {
            let title = document.getElementById('snapshot-title').value;
            let content = document.getElementById('code').value;
            stompClient.send("/share-snapshot", {}, JSON.stringify({ 'uuid': currentRoomId, 'title': title, 'content': content }));
        });

        function addSnapshot(snapshot) {
            let parsedSnapshot = JSON.parse(snapshot);
            const snapshotList = document.getElementById('snapshots');
            const li = document.createElement('li');
            li.textContent = `${parsedSnapshot.title} ${parsedSnapshot.content} (${parsedSnapshot.createdDate})`;
            snapshotList.append(li);
        }
        // auth 관련 부분
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            fetch(`${serverURL}/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email, password }),
                credentials: 'include'
            })
            .then(response => response.text())
            .then(text => {
                if (text === '성공') {
                    alert('로그인 성공!');
                } else {
                    alert('로그인 실패. 다시 시도해주세요.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('로그인 중 오류가 발생했습니다.');
            });
        });

        document.getElementById('check').addEventListener('click', function(e) {
            e.preventDefault();
            fetch(`${serverURL}/check`, {
                method: 'GET',
                credentials: 'include'
            })
            .then(response => response.text())
            .then(text => {
                alert(text);
            }).catch(err => {
                alert('에러 발생');
            })
        });

        document.getElementById('logoutButton').addEventListener('click', function() {
            // 서버 세션은 끊기는데 쿠키는 삭제가 안되네?
            document.cookie = 'JSESSIONID=; Max-Age=0; path=/; domain=localhost;';

            fetch(`${serverURL}/logout`, {
                method: 'POST',
                credentials: 'include' // 쿠키를 포함하여 요청
            })
            .then(response => response.text())
            .then(data => {
                
                alert(data);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('로그아웃 중 오류가 발생했습니다.');
            });
        });


        connect();
    </script>
</body>
</html>